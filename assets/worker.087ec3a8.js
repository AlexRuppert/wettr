!function(){"use strict";const t={light:"#444444",dark:"#9ca3aa"},e={light:"#0066ED",dark:"#2784FF"},n={light:"#FFB901",dark:"#FFC637"},r=r=>{switch(r){case"rain":case"sleet":case"hail":case"snow":case"thunderstorm":return e;case"clear-day":case"clear-night":case"partly-cloudy-day":case"partly-cloudy-night":return n;default:return t}},a="x--cache-timestamp";async function o(t,e=1e6){let n=await caches.match(t);if(n&&n.headers.get(a)&&+n.headers.get(a)+6e4*e>Date.now())return console.log("cached "+t),n;n=await fetch(t);const r=new Headers(n.headers);r.set(a,Date.now().toString());const o=n.clone(),i=new Response(o.body,{status:o.status,statusText:o.statusText,headers:r});return(await caches.open("v1")).put(t,i),n}const i="https://api.brightsky.dev/";let u=new URL(i+"current_weather"),s=new URL(i+"weather");function l({lon:t,lat:e}){return{lon:t.toFixed(3),lat:e.toFixed(3)}}function c(t=new Date,e=!1){return new Intl.DateTimeFormat("eu").format(t).replace(/\//g,"-")+function(t=new Date,e=!1){const n=/[+-]\d{4}/.exec(t.toString())[0];return`T${e?"23:59":"00:00"}:00${n.slice(0,3)+":"+n.slice(3)}`}(t,e)}function f(t,e){return Object.fromEntries(t.map((t=>[t.replaceAll(/_([a-z])/g,((t,e)=>e.toUpperCase())).replaceAll(/_\d+/g,""),e[t]])))}function p(t){let e=t.map((t=>t.temperature)).sort(((t,e)=>t-e));const[n,r]=[e[0],e[e.length-1]],a=r-n;return{min:{temperature:n},max:{temperature:r},dayGraph:t.map((({timestamp:t,temperature:e,precipitation:r,cloudCover:o})=>({timestamp:t,temperaturePercent:0===a?0:Math.abs((e-n)/a),precipitationPercent:Math.min(Math.pow(1.7*Math.sqrt(r),2),6)/6,sunninessPercent:1-o/100})))}}function h(t,e){var n=t.length;if(n>=e)return t;var r=new Uint8Array(Math.max(n<<1,e));return r.set(t,0),r}function d(t,e,n,r,a,o){for(var i=y,u=_,s=0;n>s;){var l=t[u(r,a)&e];a+=15&l;var c=l>>>4;if(c>15){var f=0,p=0;16==c?(p=3+i(r,a,2),a+=2,f=o[s-1]):17==c?(p=3+i(r,a,3),a+=3):18==c&&(p=11+i(r,a,7),a+=7);for(var h=s+p;h>s;)o[s]=f,s++}else o[s]=c,s++}return a}function v(t,e,n,r){for(var a=0,o=0,i=r.length>>>1;n>o;){var u=t[o+e];r[o<<1]=0,r[1+(o<<1)]=u,u>a&&(a=u),o++}for(;i>o;)r[o<<1]=0,r[1+(o<<1)]=0,o++;return a}function m(t,e){for(var n,r,a,o,i=t.length,u=M.bl_count,s=0;e>=s;s++)u[s]=0;for(s=1;i>s;s+=2)u[t[s]]++;var l=M.next_code;for(n=0,u[0]=0,r=1;e>=r;r++)l[r]=n=n+u[r-1]<<1;for(a=0;i>a;a+=2)0!=(o=t[a+1])&&(t[a]=l[o],l[o]++)}function w(t,e,n){for(var r=t.length,a=M.rev15,o=0;r>o;o+=2)if(0!=t[o+1])for(var i=t[o+1],u=o>>1<<4|i,s=e-i,l=t[o]<<s,c=l+(1<<s);l!=c;)n[a[l]>>>15-e]=u,l++}function g(t,e){for(var n=M.rev15,r=15-e,a=0;t.length>a;a+=2)t[a]=n[t[a]<<e-t[a+1]]>>>r}function y(t,e,n){return(t[e>>>3]|t[1+(e>>>3)]<<8)>>>(7&e)&(1<<n)-1}function b(t,e,n){return(t[e>>>3]|t[1+(e>>>3)]<<8|t[2+(e>>>3)]<<16)>>>(7&e)&(1<<n)-1}function _(t,e){return(t[e>>>3]|t[1+(e>>>3)]<<8|t[2+(e>>>3)]<<16)>>>(7&e)}const M=(D=Uint16Array,S=Uint32Array,{next_code:new D(16),bl_count:new D(16),ordr:[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],of0:[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,999,999,999],exb:[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0],ldef:new D(32),df0:[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,65535,65535],dxb:[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0],ddef:new S(32),flmap:new D(512),fltree:[],fdmap:new D(32),fdtree:[],lmap:new D(32768),ltree:[],ttree:[],dmap:new D(32768),dtree:[],imap:new D(512),itree:[],rev15:new D(32768),lhst:new S(286),dhst:new S(30),ihst:new S(19),lits:new S(15e3),strt:new D(65536),prev:new D(32768)});var D,S;!function(){for(var t=0;32768>t;t++){var e=t;M.rev15[t]=((e=(4278255360&(e=(4042322160&(e=(3435973836&(e=(2863311530&e)>>>1|(1431655765&e)<<1))>>>2|(858993459&e)<<2))>>>4|(252645135&e)<<4))>>>8|(16711935&e)<<8)>>>16|e<<16)>>>17}function n(t,e,n){for(;0!=e--;)t.push(0,n)}for(t=0;32>t;t++)M.ldef[t]=M.of0[t]<<3|M.exb[t],M.ddef[t]=M.df0[t]<<4|M.dxb[t];n(M.fltree,144,8),n(M.fltree,112,9),n(M.fltree,24,7),n(M.fltree,8,8),m(M.fltree,9),w(M.fltree,9,M.flmap),g(M.fltree,9),n(M.fdtree,32,5),m(M.fdtree,5),w(M.fdtree,5,M.fdmap),g(M.fdtree,5),n(M.itree,19,0),n(M.ltree,286,0),n(M.dtree,30,0),n(M.ttree,320,0)}();const I={table:function(){for(var t=new Uint32Array(256),e=0;256>e;e++){for(var n=e,r=0;8>r;r++)1&n?n=3988292384^n>>>1:n>>>=1;t[e]=n}return t}(),update:function(t,e,n,r){for(var a=0;r>a;a++)t=I.table[255&(t^e[n+a])]^t>>>8;return t},crc:function(t,e,n){return 4294967295^I.update(4294967295,t,e,n)}};const E=Math.PI/180;function L(t){return Math.log(Math.tan(P(t)/2+Math.PI/4))}function P(t){return t*E}function x(t,{lon:e,lat:n}){return{x:P(e-t.lb.lon),y:L(n)-L(t.lb.lat)}}function C(t){const e=[];return t.forEach((t=>{const n=t.lon_bucket,r=t.lat_bucket,a=(o=Uint8Array.from(atob(t.data).split("").map((t=>t.charCodeAt(0)))),function(t,e){return function(t,e){var n=Uint8Array;if(3==t[0]&&0==t[1])return e||new n(0);var r=b,a=y,o=d,i=_,u=null==e;u&&(e=new n(t.length>>>2<<3));for(var s,l,c=0,f=0,p=0,g=0,D=0,S=0,I=0,E=0,L=0;0==c;)if(c=r(t,L,1),f=r(t,L+1,2),L+=3,0!=f){if(u&&(e=h(e,E+(1<<17))),1==f&&(s=M.flmap,l=M.fdmap,S=511,I=31),2==f){p=a(t,L,5)+257,g=a(t,L+5,5)+1,D=a(t,L+10,4)+4,L+=14;for(var P=0;38>P;P+=2)M.itree[P]=0,M.itree[P+1]=0;var x=1;for(P=0;D>P;P++){var C=a(t,L+3*P,3);M.itree[1+(M.ordr[P]<<1)]=C,C>x&&(x=C)}L+=3*D,m(M.itree,x),w(M.itree,x,M.imap),s=M.lmap,l=M.dmap,L=o(M.imap,(1<<x)-1,p+g,t,L,M.ttree);var A=v(M.ttree,0,p,M.ltree);S=(1<<A)-1;var T=v(M.ttree,p,g,M.dtree);I=(1<<T)-1,m(M.ltree,A),w(M.ltree,A,s),m(M.dtree,T),w(M.dtree,T,l)}for(;;){var U=s[i(t,L)&S];L+=15&U;var k=U>>>4;if(k>>>8==0)e[E++]=k;else{if(256==k)break;var O=E+k-254;if(k>264){var j=M.ldef[k-257];O=E+(j>>>3)+a(t,L,7&j),L+=7&j}var F=l[i(t,L)&I],Z=M.ddef[F>>>4],$=(Z>>>4)+r(t,L+=15&F,15&Z);for(L+=15&Z,u&&(e=h(e,E+(1<<17)));O>E;)e[E]=e[E++-$],e[E]=e[E++-$],e[E]=e[E++-$],e[E]=e[E++-$];E=O}}}else{0!=(7&L)&&(L+=8-(7&L));var B=4+(L>>>3),R=t[B-4]|t[B-3]<<8;u&&(e=h(e,E+R)),e.set(new n(t.buffer,t.byteOffset+B,R),E),L=B+R<<3,E+=R}return e.length==E?e:e.slice(0,E)}(t,e)}(new Uint8Array(o.buffer,o.byteOffset+2,o.length-6),undefined));var o;let i=0;for(let u=0;a.length>u;u++){const o=a[u];128&o?i+=-129&o:(e.push({time:t.time,lon:n+i%100/100,lat:r+(i/100|0)/100,value:o/100}),i++)}})),e}function A(t,e){const n=new Date(t);return new Date(n.setMinutes(n.getMinutes()+e))}function T(t,e,n,r,a,o){var i=(o-e)*(n-t)-(r-e)*(a-t);return i>0||i>=0}function U(t){var e=[];t.forEach((function(t){var n=this.point2CellXY(t),r=n[0],a=n[1];void 0===e[r]&&(e[r]=[]),void 0===e[r][a]&&(e[r][a]=[]),e[r][a].push(t)}),this),this.cellPoints=function(t,n){return void 0!==e[t]&&void 0!==e[t][n]?e[t][n]:[]},this.removePoint=function(t){for(var n,r=this.point2CellXY(t),a=e[r[0]][r[1]],o=0;a.length>o;o++)if(a[o][0]===t[0]&&a[o][1]===t[1]){n=o;break}return a.splice(n,1),a}}U.prototype={point2CellXY:function(t){return[parseInt(t[0]/U.CELL_SIZE),parseInt(t[1]/U.CELL_SIZE)]},rangePoints:function(t){for(var e=this.point2CellXY([t[0],t[1]]),n=this.point2CellXY([t[2],t[3]]),r=[],a=e[0];n[0]>=a;a++)for(var o=e[1];n[1]>=o;o++)r=r.concat(this.cellPoints(a,o));return r},addBorder2Bbox:function(t,e){return[t[0]-e*U.CELL_SIZE,t[1]-e*U.CELL_SIZE,t[2]+e*U.CELL_SIZE,t[3]+e*U.CELL_SIZE]}},U.CELL_SIZE=10;var k=function(t,e){var n=t[0][0],r=t[0][1],a=t[1][0],o=t[1][1],i=e[0][0],u=e[0][1],s=e[1][0],l=e[1][1];return T(n,r,i,u,s,l)!==T(a,o,i,u,s,l)&&T(n,r,a,o,i,u)!==T(n,r,a,o,s,l)};function O(t,e,n){return(e[0]-t[0])*(n[1]-t[1])-(e[1]-t[1])*(n[0]-t[0])}function j(t,e){return Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)}function F(t,e,n){var r=[e[0]-t[0],e[1]-t[1]],a=[n[0]-t[0],n[1]-t[1]],o=j(t,e),i=j(t,n);return(r[0]*a[0]+r[1]*a[1])/Math.sqrt(o*i)}function Z(t,e){for(var n=0;e.length-1>n;n++){var r=[e[n],e[n+1]];if(!(t[0][0]===r[0][0]&&t[0][1]===r[0][1]||t[0][0]===r[1][0]&&t[0][1]===r[1][1])&&k(t,r))return!0}return!1}function $(t,e){var n,r,a,o;return t[1][0]>t[0][0]?(n=t[0][0]-e,r=t[1][0]+e):(n=t[1][0]-e,r=t[0][0]+e),t[1][1]>t[0][1]?(a=t[0][1]-e,o=t[1][1]+e):(a=t[1][1]-e,o=t[0][1]+e),[n,a,r,o]}function B(t,e,n){for(var r,a,o=null,i=X,u=X,s=0;e.length>s;s++)r=F(t[0],t[1],e[s]),a=F(t[1],t[0],e[s]),r>i&&a>u&&!Z([t[0],e[s]],n)&&!Z([t[1],e[s]],n)&&(i=r,u=a,o=e[s]);return o}function R(t,e,n,r){for(var a,o,i,u,s,l=!1,c=0;t.length-1>c;c++)if(j((a=[t[c],t[c+1]])[0],a[1])>=e){o=0,s=$(a,i=Y);do{i=(s=r.addBorder2Bbox(s,o))[2]-s[0],u=B(a,r.rangePoints(s),t),o++}while(null===u&&n>i);null!==u&&(t.splice(c+1,0,u),r.removePoint(u),l=!0)}return l?R(t,e,n,r):t}var X=Math.cos(90/(180/Math.PI)),Y=5,z=function(t,e){var n,r,a,o,i,u=e||20;return 4>t.length?t:(r=function(t){for(var e=[],n=0;t.length>n;n++){for(;e.length>=2&&0>=O(e[e.length-2],e[e.length-1],t[n]);)e.pop();e.push(t[n])}return e.pop(),e}(t=function(t){return t.sort((function(t,e){return t[0]==e[0]?t[1]-e[1]:t[0]-e[0]}))}(t)),n=function(t){for(var e=t.reverse(),n=[],r=0;e.length>r;r++){for(;n.length>=2&&0>=O(n[n.length-2],n[n.length-1],e[r]);)n.pop();n.push(e[r])}return n.pop(),n}(t),(a=n.concat(r)).push(t[0]),i=.8*Math.max(t[t.length-1][0],function(t){for(var e=-1/0,n=t.length-1;n>=0;n--)t[n][1]>e&&(e=t[n][1]);return e}(a)),o=t.filter((function(t){return 0>a.indexOf(t)})),R(a,Math.pow(u,2),i,new U(o)))},W={};function q(t,e){return t*t+e*e}function H(t,e,n){var r=e[0],a=e[1],o=n[0]-r,i=n[1]-a;if(0!==o||0!==i){var u=((t[0]-r)*o+(t[1]-a)*i)/q(o,i);u>1?(r=n[0],a=n[1]):u>0&&(r+=o*u,a+=i*u)}return q(t[0]-r,t[1]-a)}function N(t,e,n,r,a){for(var o,i=r,u=e+1;n>u;u++){var s=H(t[u],t[e],t[n]);s>i&&(o=u,i=s)}i>r&&(o-e>1&&N(t,e,o,r,a),a.push(t[o]),n-o>1&&N(t,o,n,r,a))}function G(t,e){var n=t.length-1,r=[t[0]];return N(t,0,n,e,r),r.push(t[n]),r}W.__esModule=!0,W.SimplifyAP=function(t,e,n){if(void 0===e&&(e=1),void 0===n&&(n=!1),2>=t.length)return t;var r=e*e;return t=n?t:function(t,e){for(var n,r,a,o=t[0],i=[o],u=1,s=t.length;s>u;u++)q((r=n=t[u])[0]-(a=o)[0],r[1]-a[1])>e&&(i.push(n),o=n);return o!==n&&i.push(n),i}(t,r),G(t,r)};var J=W.SimplifyAP;function K(t,e,n){return t.level>2&&e>n}onmessage=async function({data:{type:t,data:e}}){let n;switch(t){case"currentWeatherData":n=async function(t,e){return u.search=new URLSearchParams({...l({lon:e,lat:t}),tz:Intl.DateTimeFormat().resolvedOptions().timeZone}).toString(),function(t){const e=f(["timestamp","cloud_cover","condition","dew_point","precipitation_60","pressure_msl","relative_humidity","visibility","wind_direction_10","wind_speed_10","wind_gust_direction_10","wind_gust_speed_10","sunshine_30","temperature","icon"],t.weather);return{...e,temperature:Math.round(e.temperature)}}(await(await o(u.toString(),9)).json())}(e.lat,e.lon);break;case"weatherData":n=async function(t,e,n=3){const a=new Date,i=new Date(a.getTime()+864e5*n-10);s.search=new URLSearchParams({...l({lon:e,lat:t}),days:n.toString(),date:c(a),last_date:c(i,!0)}).toString();const u=function(t,e,n){const a=new Map;return t.weather.forEach((t=>{var e,n;const r=f(Object.keys(t),t),o={...r,temperature:Math.round(r.temperature),hours:new Date(r.timestamp).getHours()},[i,u]=o.timestamp.split("T"),s=+o.timestamp.split("+")[1].replace(":","")/100;let l=new Date(new Date(i).getTime()-36e5*s);if(u.startsWith("00")){const t=new Date(l.getTime()-864e5);null==(e=a.get(t.toISOString()))||e.push({...o})}null!=(null==(n=a.get(l.toISOString()))?void 0:n.push(o))||a.set(l.toISOString(),[o])})),Array.from(a.entries()).map((([t,a])=>{const o=new Date(t),i=function(t,e,n){const r=new Date(t.toISOString().substr(0,10)+"T12:00Z");function a(t){return Math.sin(t*(Math.PI/180))}function o(t){return Math.cos(t*(Math.PI/180))}function i(t){return new Date(864e5*(t-2440587.5))}const u=Math.floor(r.getTime()/864e5+2440587.5)-2451545+8e-4-n/360,s=(357.5291+.98560028*u)%360,l=(s+(1.9148*a(s)+.02*a(2*s)+3e-4*a(3*s))+180+102.9372)%360,c=2451545+u+.0053*a(s)-.0069*a(2*l),f=(p=a(l)*a(23.44),Math.asin(p)*(180/Math.PI));var p;const h=function(t){return Math.acos(t)*(180/Math.PI)}((a(-.83)-a(e)*a(f))/(o(e)*o(f)));return{sunrise:i(c-h/360),sunset:i(c+h/360)}}(o,e,n);let u={day:[],morning:[],noon:[],evening:[]};return a.forEach((t=>{[["day",0,24],["morning",4,9],["noon",10,22],["evening",18,22]].forEach((([e,n,r])=>{return(a=t.hours)>=+n&&+r>=a&&u[e].push(t);var a}))})),{day:o,dayLight:i,dayParts:[u.morning,u.noon,u.evening].map((t=>{const e=function(t){const e=new Map;let n="clear-day",r=0;return t.forEach((t=>{var a;const o=t.icon.replace("night","day"),i=(null!=(a=e.get(o))?a:0)+(t=>/thunderstorm|hail/.test(t)?12:1)(o);e.set(o,i),i>r&&(r=i,n=o)})),n}(t);return{icon:e,colors:r(e)}})),...p(u.day),data:a}}))}(await(await o(s.toString(),9)).json(),t,e);return u}(e.lat,e.lon,e.days);break;case"cloudData":case"currentCloudData":n=async function(t,e=!1){let n=(await async function(t,e=!1){return C(await(await o(`https://wettr-service.vercel.app/api/clouds?bounds=${t.lb.lon},${t.rt.lon},${t.lb.lat},${t.rt.lat}${e?"&onlyNow=true":""}`,9)).json())}(t,e)).filter((e=>function({lon:t,lat:e},n){const r=.02;return!(n.lb.lon>t+r||t-r>n.rt.lon||n.lb.lat>e+r||e-r>n.rt.lat)}(e,t))).map((e=>({...e,projected:x(t,e)})));return n.sort(((t,e)=>t.value-e.value)),n=Array.from(new Map(n.map((t=>[`${t.time} ${1e4*t.projected.x|0} ${1e4*t.projected.y|0}`,t]))).values()),{times:function(){const t=new Date(Date.now()-3e5).toISOString(),e=15*(+t.match(/:(\d\d):/)[1]/15|0),n=A(new Date(t.substring(0,13)+":00:00Z"),e);return[...Array(9)].map(((t,e)=>A(n,15*e)))}(),clouds:n,viewBounds:t}}(e.bounds,e.onlyNow);break;case"weatherWarningData":n=async function(){return function(t){const e=Date.now();return function(t){const e=t.slice();return e.sort(((t,e)=>{const n=t.level-e.level;return 0===n?t.time.start.getTime()-e.time.start.getTime():n})),e}(t.warnings.map((t=>{return{event:(n=t.event,n.toLowerCase().replace(/(^|\s)\p{L}/gu,(t=>t.toUpperCase()))),description:t.description,time:{start:new Date(t.start),end:new Date(t.end)},instruction:t.instruction,level:t.level,type:t.type,regions:K(t,t.end,e)?t.regions.map((t=>function(t){const e={lon:100,lat:100},n={lon:0,lat:0},r=[];for(let o=0;t.length/2>o;o+=3)r.push([t[2*o+1],t[2*o]]);const a=J(z(r,.1),.02,!1);for(let o=0;a.length>o;o++){const[t,r]=a[o];e.lon>t?e.lon=t:t>n.lon&&(n.lon=t),e.lat>r?e.lat=r:r>n.lat&&(n.lat=r)}return{polygon:a,bounds:{lb:e,rt:n}}}(t.polygon))):[],urls:t.urls};var n})).filter((t=>K(t,t.time.end,e))))}(await(await o("https://s3.eu-central-1.amazonaws.com/app-prod-static.warnwetter.de/v16/gemeinde_warnings_v2.json",19)).json())}()}postMessage({type:t,data:await n})}}();
