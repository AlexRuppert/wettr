!function(){"use strict";const t="x--cache-timestamp";async function e(e,n=1e6){let r=await caches.match(e);if(r&&r.headers.get(t)&&+r.headers.get(t)+6e4*n>Date.now())return console.log("cached "+e),r;r=await fetch(e);const a=new Headers(r.headers);a.set(t,Date.now().toString());const o=r.clone(),i=new Response(o.body,{status:o.status,statusText:o.statusText,headers:a});return(await caches.open("v1")).put(e,i),r}const n="https://api.brightsky.dev/";let r=new URL(n+"current_weather"),a=new URL(n+"weather");function o({lon:t,lat:e}){return{lon:t.toFixed(3),lat:e.toFixed(3)}}function i(t=new Date,e=!1){return new Intl.DateTimeFormat("eu").format(t).replace(/\//g,"-")+function(t=new Date,e=!1){const n=/[+-]\d{4}/.exec(t.toString())[0];return`T${e?"23:59":"00:00"}:00${n.slice(0,3)+":"+n.slice(3)}`}(t,e)}function u(t,e){return Object.fromEntries(t.map((t=>[t.replaceAll(/_([a-z])/g,((t,e)=>e.toUpperCase())).replaceAll(/_\d+/g,""),e[t]])))}function s(t){let e=t.map((t=>t.temperature)).sort(((t,e)=>t-e));const[n,r]=[e[0],e[e.length-1]],a=r-n;return{min:{temperature:n},max:{temperature:r},dayGraph:t.map((({timestamp:t,temperature:e,precipitation:r,cloudCover:o})=>({timestamp:new Date(t),temperaturePercent:0===a?0:Math.abs((e-n)/a),temperature:e,precipitationPercent:Math.min(Math.pow(1.7*Math.sqrt(r),2),6)/6,sunninessPercent:1-o/100})))}}function l(t,e){var n=t.length;if(n>=e)return t;var r=new Uint8Array(Math.max(n<<1,e));return r.set(t,0),r}function c(t,e,n,r,a,o){for(var i=v,u=w,s=0;n>s;){var l=t[u(r,a)&e];a+=15&l;var c=l>>>4;if(c>15){var f=0,p=0;16==c?(p=3+i(r,a,2),a+=2,f=o[s-1]):17==c?(p=3+i(r,a,3),a+=3):18==c&&(p=11+i(r,a,7),a+=7);for(var h=s+p;h>s;)o[s]=f,s++}else o[s]=c,s++}return a}function f(t,e,n,r){for(var a=0,o=0,i=r.length>>>1;n>o;){var u=t[o+e];r[o<<1]=0,r[1+(o<<1)]=u,u>a&&(a=u),o++}for(;i>o;)r[o<<1]=0,r[1+(o<<1)]=0,o++;return a}function p(t,e){for(var n,r,a,o,i=t.length,u=g.bl_count,s=0;e>=s;s++)u[s]=0;for(s=1;i>s;s+=2)u[t[s]]++;var l=g.next_code;for(n=0,u[0]=0,r=1;e>=r;r++)l[r]=n=n+u[r-1]<<1;for(a=0;i>a;a+=2)0!=(o=t[a+1])&&(t[a]=l[o],l[o]++)}function h(t,e,n){for(var r=t.length,a=g.rev15,o=0;r>o;o+=2)if(0!=t[o+1])for(var i=t[o+1],u=o>>1<<4|i,s=e-i,l=t[o]<<s,c=l+(1<<s);l!=c;)n[a[l]>>>15-e]=u,l++}function d(t,e){for(var n=g.rev15,r=15-e,a=0;t.length>a;a+=2)t[a]=n[t[a]<<e-t[a+1]]>>>r}function v(t,e,n){return(t[e>>>3]|t[1+(e>>>3)]<<8)>>>(7&e)&(1<<n)-1}function m(t,e,n){return(t[e>>>3]|t[1+(e>>>3)]<<8|t[2+(e>>>3)]<<16)>>>(7&e)&(1<<n)-1}function w(t,e){return(t[e>>>3]|t[1+(e>>>3)]<<8|t[2+(e>>>3)]<<16)>>>(7&e)}const g=(y=Uint16Array,b=Uint32Array,{next_code:new y(16),bl_count:new y(16),ordr:[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],of0:[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,999,999,999],exb:[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0],ldef:new y(32),df0:[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,65535,65535],dxb:[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0],ddef:new b(32),flmap:new y(512),fltree:[],fdmap:new y(32),fdtree:[],lmap:new y(32768),ltree:[],ttree:[],dmap:new y(32768),dtree:[],imap:new y(512),itree:[],rev15:new y(32768),lhst:new b(286),dhst:new b(30),ihst:new b(19),lits:new b(15e3),strt:new y(65536),prev:new y(32768)});var y,b;!function(){for(var t=0;32768>t;t++){var e=t;g.rev15[t]=((e=(4278255360&(e=(4042322160&(e=(3435973836&(e=(2863311530&e)>>>1|(1431655765&e)<<1))>>>2|(858993459&e)<<2))>>>4|(252645135&e)<<4))>>>8|(16711935&e)<<8)>>>16|e<<16)>>>17}function n(t,e,n){for(;0!=e--;)t.push(0,n)}for(t=0;32>t;t++)g.ldef[t]=g.of0[t]<<3|g.exb[t],g.ddef[t]=g.df0[t]<<4|g.dxb[t];n(g.fltree,144,8),n(g.fltree,112,9),n(g.fltree,24,7),n(g.fltree,8,8),p(g.fltree,9),h(g.fltree,9,g.flmap),d(g.fltree,9),n(g.fdtree,32,5),p(g.fdtree,5),h(g.fdtree,5,g.fdmap),d(g.fdtree,5),n(g.itree,19,0),n(g.ltree,286,0),n(g.dtree,30,0),n(g.ttree,320,0)}();const _={table:function(){for(var t=new Uint32Array(256),e=0;256>e;e++){for(var n=e,r=0;8>r;r++)1&n?n=3988292384^n>>>1:n>>>=1;t[e]=n}return t}(),update:function(t,e,n,r){for(var a=0;r>a;a++)t=_.table[255&(t^e[n+a])]^t>>>8;return t},crc:function(t,e,n){return 4294967295^_.update(4294967295,t,e,n)}};const M=Math.PI/180;function D(t){return Math.log(Math.tan(S(t)/2+Math.PI/4))}function S(t){return t*M}function I(t,{lon:e,lat:n}){return{x:S(e-t.lb.lon),y:D(n)-D(t.lb.lat)}}function E(t){const e=[];return t.forEach((t=>{const n=t.lon_bucket,r=t.lat_bucket,a=(o=Uint8Array.from(atob(t.data).split("").map((t=>t.charCodeAt(0)))),function(t,e){return function(t,e){var n=Uint8Array;if(3==t[0]&&0==t[1])return e||new n(0);var r=m,a=v,o=c,i=w,u=null==e;u&&(e=new n(t.length>>>2<<3));for(var s,d,y=0,b=0,_=0,M=0,D=0,S=0,I=0,E=0,L=0;0==y;)if(y=r(t,L,1),b=r(t,L+1,2),L+=3,0!=b){if(u&&(e=l(e,E+(1<<17))),1==b&&(s=g.flmap,d=g.fdmap,S=511,I=31),2==b){_=a(t,L,5)+257,M=a(t,L+5,5)+1,D=a(t,L+10,4)+4,L+=14;for(var P=0;38>P;P+=2)g.itree[P]=0,g.itree[P+1]=0;var x=1;for(P=0;D>P;P++){var C=a(t,L+3*P,3);g.itree[1+(g.ordr[P]<<1)]=C,C>x&&(x=C)}L+=3*D,p(g.itree,x),h(g.itree,x,g.imap),s=g.lmap,d=g.dmap,L=o(g.imap,(1<<x)-1,_+M,t,L,g.ttree);var A=f(g.ttree,0,_,g.ltree);S=(1<<A)-1;var T=f(g.ttree,_,M,g.dtree);I=(1<<T)-1,p(g.ltree,A),h(g.ltree,A,s),p(g.dtree,T),h(g.dtree,T,d)}for(;;){var U=s[i(t,L)&S];L+=15&U;var O=U>>>4;if(O>>>8==0)e[E++]=O;else{if(256==O)break;var j=E+O-254;if(O>264){var Z=g.ldef[O-257];j=E+(Z>>>3)+a(t,L,7&Z),L+=7&Z}var $=d[i(t,L)&I],k=g.ddef[$>>>4],B=(k>>>4)+r(t,L+=15&$,15&k);for(L+=15&k,u&&(e=l(e,E+(1<<17)));j>E;)e[E]=e[E++-B],e[E]=e[E++-B],e[E]=e[E++-B],e[E]=e[E++-B];E=j}}}else{0!=(7&L)&&(L+=8-(7&L));var R=4+(L>>>3),X=t[R-4]|t[R-3]<<8;u&&(e=l(e,E+X)),e.set(new n(t.buffer,t.byteOffset+R,X),E),L=R+X<<3,E+=X}return e.length==E?e:e.slice(0,E)}(t,e)}(new Uint8Array(o.buffer,o.byteOffset+2,o.length-6),undefined));var o;let i=0;for(let u=0;a.length>u;u++){const o=a[u];128&o?i+=-129&o:(e.push({time:t.time,lon:n+i%100/100,lat:r+(i/100|0)/100,value:o/100}),i++)}})),e}function L(t,e){const n=new Date(t);return new Date(n.setMinutes(n.getMinutes()+e))}function P(t,e,n,r,a,o){var i=(o-e)*(n-t)-(r-e)*(a-t);return i>0||i>=0}function x(t){var e=[];t.forEach((function(t){var n=this.point2CellXY(t),r=n[0],a=n[1];void 0===e[r]&&(e[r]=[]),void 0===e[r][a]&&(e[r][a]=[]),e[r][a].push(t)}),this),this.cellPoints=function(t,n){return void 0!==e[t]&&void 0!==e[t][n]?e[t][n]:[]},this.removePoint=function(t){for(var n,r=this.point2CellXY(t),a=e[r[0]][r[1]],o=0;a.length>o;o++)if(a[o][0]===t[0]&&a[o][1]===t[1]){n=o;break}return a.splice(n,1),a}}x.prototype={point2CellXY:function(t){return[parseInt(t[0]/x.CELL_SIZE),parseInt(t[1]/x.CELL_SIZE)]},rangePoints:function(t){for(var e=this.point2CellXY([t[0],t[1]]),n=this.point2CellXY([t[2],t[3]]),r=[],a=e[0];n[0]>=a;a++)for(var o=e[1];n[1]>=o;o++)r=r.concat(this.cellPoints(a,o));return r},addBorder2Bbox:function(t,e){return[t[0]-e*x.CELL_SIZE,t[1]-e*x.CELL_SIZE,t[2]+e*x.CELL_SIZE,t[3]+e*x.CELL_SIZE]}},x.CELL_SIZE=10;var C=function(t,e){var n=t[0][0],r=t[0][1],a=t[1][0],o=t[1][1],i=e[0][0],u=e[0][1],s=e[1][0],l=e[1][1];return P(n,r,i,u,s,l)!==P(a,o,i,u,s,l)&&P(n,r,a,o,i,u)!==P(n,r,a,o,s,l)};function A(t,e,n){return(e[0]-t[0])*(n[1]-t[1])-(e[1]-t[1])*(n[0]-t[0])}function T(t,e){return Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)}function U(t,e,n){var r=[e[0]-t[0],e[1]-t[1]],a=[n[0]-t[0],n[1]-t[1]],o=T(t,e),i=T(t,n);return(r[0]*a[0]+r[1]*a[1])/Math.sqrt(o*i)}function O(t,e){for(var n=0;e.length-1>n;n++){var r=[e[n],e[n+1]];if(!(t[0][0]===r[0][0]&&t[0][1]===r[0][1]||t[0][0]===r[1][0]&&t[0][1]===r[1][1])&&C(t,r))return!0}return!1}function j(t,e){var n,r,a,o;return t[1][0]>t[0][0]?(n=t[0][0]-e,r=t[1][0]+e):(n=t[1][0]-e,r=t[0][0]+e),t[1][1]>t[0][1]?(a=t[0][1]-e,o=t[1][1]+e):(a=t[1][1]-e,o=t[0][1]+e),[n,a,r,o]}function Z(t,e,n){for(var r,a,o=null,i=k,u=k,s=0;e.length>s;s++)r=U(t[0],t[1],e[s]),a=U(t[1],t[0],e[s]),r>i&&a>u&&!O([t[0],e[s]],n)&&!O([t[1],e[s]],n)&&(i=r,u=a,o=e[s]);return o}function $(t,e,n,r){for(var a,o,i,u,s,l=!1,c=0;t.length-1>c;c++)if(T((a=[t[c],t[c+1]])[0],a[1])>=e){o=0,s=j(a,i=B);do{i=(s=r.addBorder2Bbox(s,o))[2]-s[0],u=Z(a,r.rangePoints(s),t),o++}while(null===u&&n>i);null!==u&&(t.splice(c+1,0,u),r.removePoint(u),l=!0)}return l?$(t,e,n,r):t}var k=Math.cos(90/(180/Math.PI)),B=5,R=function(t,e){var n,r,a,o,i,u=e||20;return 4>t.length?t:(r=function(t){for(var e=[],n=0;t.length>n;n++){for(;e.length>=2&&0>=A(e[e.length-2],e[e.length-1],t[n]);)e.pop();e.push(t[n])}return e.pop(),e}(t=function(t){return t.sort((function(t,e){return t[0]==e[0]?t[1]-e[1]:t[0]-e[0]}))}(t)),n=function(t){for(var e=t.reverse(),n=[],r=0;e.length>r;r++){for(;n.length>=2&&0>=A(n[n.length-2],n[n.length-1],e[r]);)n.pop();n.push(e[r])}return n.pop(),n}(t),(a=n.concat(r)).push(t[0]),i=.8*Math.max(t[t.length-1][0],function(t){for(var e=-1/0,n=t.length-1;n>=0;n--)t[n][1]>e&&(e=t[n][1]);return e}(a)),o=t.filter((function(t){return 0>a.indexOf(t)})),$(a,Math.pow(u,2),i,new x(o)))},X={};function Y(t,e){return t*t+e*e}function F(t,e,n){var r=e[0],a=e[1],o=n[0]-r,i=n[1]-a;if(0!==o||0!==i){var u=((t[0]-r)*o+(t[1]-a)*i)/Y(o,i);u>1?(r=n[0],a=n[1]):u>0&&(r+=o*u,a+=i*u)}return Y(t[0]-r,t[1]-a)}function z(t,e,n,r,a){for(var o,i=r,u=e+1;n>u;u++){var s=F(t[u],t[e],t[n]);s>i&&(o=u,i=s)}i>r&&(o-e>1&&z(t,e,o,r,a),a.push(t[o]),n-o>1&&z(t,o,n,r,a))}function W(t,e){var n=t.length-1,r=[t[0]];return z(t,0,n,e,r),r.push(t[n]),r}X.__esModule=!0,X.SimplifyAP=function(t,e,n){if(void 0===e&&(e=1),void 0===n&&(n=!1),2>=t.length)return t;var r=e*e;return t=n?t:function(t,e){for(var n,r,a,o=t[0],i=[o],u=1,s=t.length;s>u;u++)Y((r=n=t[u])[0]-(a=o)[0],r[1]-a[1])>e&&(i.push(n),o=n);return o!==n&&i.push(n),i}(t,r),W(t,r)};var q=X.SimplifyAP;function H(t,e,n){return t.level>2&&e>n}onmessage=async function({data:{type:t,data:n}}){let l;switch(t){case"currentWeatherData":l=async function(t,n){return r.search=new URLSearchParams({...o({lon:n,lat:t}),tz:Intl.DateTimeFormat().resolvedOptions().timeZone}).toString(),function(t){const e=u(["timestamp","cloud_cover","condition","dew_point","precipitation_60","pressure_msl","relative_humidity","visibility","wind_direction_10","wind_speed_10","wind_gust_direction_10","wind_gust_speed_10","sunshine_30","temperature","icon"],t.weather);return{...e,temperature:Math.round(e.temperature)}}(await(await e(r.toString(),9)).json())}(n.lat,n.lon);break;case"weatherData":l=async function(t,n,r=3){const l=new Date,c=new Date(l.getTime()+864e5*r-10);a.search=new URLSearchParams({...o({lon:n,lat:t}),days:r.toString(),date:i(l),last_date:i(c,!0)}).toString();const f=function(t,e,n){const r=new Map;return t.weather.forEach((t=>{var e,n;const a=u(Object.keys(t),t),o={...a,temperature:Math.round(a.temperature),hours:new Date(a.timestamp).getHours()},[i,s]=o.timestamp.split("T"),l=+o.timestamp.split("+")[1].replace(":","")/100;let c=new Date(new Date(i).getTime()-36e5*l);if(s.startsWith("00")){const t=new Date(c.getTime()-864e5);null==(e=r.get(t.toISOString()))||e.push({...o})}null!=(null==(n=r.get(c.toISOString()))?void 0:n.push(o))||r.set(c.toISOString(),[o])})),Array.from(r.entries()).map((([t,r])=>{const a=new Date(t),o=function(t,e,n){const r=new Date(t.toISOString().substr(0,10)+"T12:00Z");function a(t){return Math.sin(t*(Math.PI/180))}function o(t){return Math.cos(t*(Math.PI/180))}function i(t){return new Date(864e5*(t-2440587.5))}const u=Math.floor(r.getTime()/864e5+2440587.5)-2451545+8e-4-n/360,s=(357.5291+.98560028*u)%360,l=(s+(1.9148*a(s)+.02*a(2*s)+3e-4*a(3*s))+180+102.9372)%360,c=2451545+u+.0053*a(s)-.0069*a(2*l),f=(p=a(l)*a(23.44),Math.asin(p)*(180/Math.PI));var p;const h=function(t){return Math.acos(t)*(180/Math.PI)}((a(-.83)-a(e)*a(f))/(o(e)*o(f)));return{sunrise:i(c-h/360),sunset:i(c+h/360)}}(a,e,n);let i={day:[],morning:[],noon:[],evening:[]};return r.forEach((t=>{[["day",0,24],["morning",4,9],["noon",10,22],["evening",18,22]].forEach((([e,n,r])=>{return(a=t.hours)>=+n&&+r>=a&&i[e].push(t);var a}))})),{day:a,dayLight:o,dayParts:[i.morning,i.noon,i.evening].map((t=>({icon:function(t){const e=new Map;let n="clear-day",r=0;return t.forEach((t=>{var a;const o=t.icon.replace("night","day"),i=(null!=(a=e.get(o))?a:0)+(t=>/thunderstorm|hail/.test(t)?12:1)(o);e.set(o,i),i>r&&(r=i,n=o)})),n}(t)}))),...s(i.day),data:r}}))}(await(await e(a.toString(),9)).json(),t,n);return f}(n.lat,n.lon,n.days);break;case"cloudData":case"currentCloudData":l=async function(t,n=!1){let r=(await async function(t,n=!1){return E(await(await e(`https://wettr-service.vercel.app/api/clouds?bounds=${t.lb.lon},${t.rt.lon},${t.lb.lat},${t.rt.lat}${n?"&onlyNow=true":""}`,9)).json())}(t,n)).filter((e=>function({lon:t,lat:e},n){const r=.02;return!(n.lb.lon>t+r||t-r>n.rt.lon||n.lb.lat>e+r||e-r>n.rt.lat)}(e,t))).map((e=>({...e,projected:I(t,e)})));return r.sort(((t,e)=>t.value-e.value)),r=Array.from(new Map(r.map((t=>[`${t.time} ${1e4*t.projected.x|0} ${1e4*t.projected.y|0}`,t]))).values()),{times:function(){const t=new Date(Date.now()-3e5).toISOString(),e=15*(+t.match(/:(\d\d):/)[1]/15|0),n=L(new Date(t.substring(0,13)+":00:00Z"),e);return[...Array(9)].map(((t,e)=>L(n,15*e)))}(),clouds:r,viewBounds:t}}(n.bounds,n.onlyNow);break;case"weatherWarningData":l=async function(){return function(t){const e=Date.now();return function(t){const e=t.slice();return e.sort(((t,e)=>{const n=t.level-e.level;return 0===n?t.time.start.getTime()-e.time.start.getTime():n})),e}(t.warnings.map((t=>{return{event:(n=t.event,n.toLowerCase().replace(/(^|\s)\p{L}/gu,(t=>t.toUpperCase()))),description:t.description,time:{start:new Date(t.start),end:new Date(t.end)},instruction:t.instruction,level:t.level,type:t.type,regions:H(t,t.end,e)?t.regions.map((t=>function(t){const e={lon:100,lat:100},n={lon:0,lat:0},r=[];for(let o=0;t.length/2>o;o+=3)r.push([t[2*o+1],t[2*o]]);const a=q(R(r,.1),.02,!1);for(let o=0;a.length>o;o++){const[t,r]=a[o];e.lon>t?e.lon=t:t>n.lon&&(n.lon=t),e.lat>r?e.lat=r:r>n.lat&&(n.lat=r)}return{polygon:a,bounds:{lb:e,rt:n}}}(t.polygon))):[],urls:t.urls};var n})).filter((t=>H(t,t.time.end,e))))}(await(await e("https://s3.eu-central-1.amazonaws.com/app-prod-static.warnwetter.de/v16/gemeinde_warnings_v2.json",19)).json())}()}postMessage({type:t,data:await l})}}();
