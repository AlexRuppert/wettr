!function(){"use strict";function t(t){switch(t){case"rain":case"sleet":case"hail":case"snow":case"thunderstorm":return"rain";case"clear-day":case"clear-night":case"partly-cloudy-day":case"partly-cloudy-night":return"sun";default:return"other"}}function e({lon:t,lat:e}){return{lon:t.toFixed(3),lat:e.toFixed(3)}}const a="x--cache-timestamp";async function n(t,e=1e6){let n=await caches.match(t);if(n&&n.headers.get(a)&&+n.headers.get(a)+6e4*e>Date.now())return console.log("cached "+t),n;n=await fetch(t);const r=new Headers(n.headers);r.set(a,Date.now().toString());const s=n.clone(),i=new Response(s.body,{status:s.status,statusText:s.statusText,headers:r});return(await caches.open("v1")).put(t,i),n}const r="https://api.brightsky.dev/";let s=new URL(r+"current_weather"),i=new URL(r+"weather");let o=new URL("https://api.brightsky.dev/alerts");onmessage=async function({data:{type:a,data:r}}){let c;switch(a){case"currentWeatherData":c=async function(t){return s.search=new URLSearchParams({...e(t),tz:"Europe/Berlin"}).toString(),{...(a=await(await n(s.toString(),9)).json()).weather,temperature:Math.round(a.weather.temperature)};var a}(r);break;case"weatherData":c=async function(a,r=3){const s=new Date,o=new Date(s.getTime()+864e5*r-10);return i.search=new URLSearchParams({...e(a),date:s.toISOString().split("T")[0],last_date:o.toISOString().split("T")[0],tz:"Europe/Berlin"}).toString(),function(e,a){const n=function(t){const e=[];for(let a=0;t.length>a;a+=24)e.push(t.slice(a,a+24));return e}(e.weather.map((t=>({...t,temperature:Math.round(t.temperature),hours:new Date(t.timestamp).getHours()})))).slice(0,-1),r=n.map((e=>{const n=new Date(e[0].timestamp),r=function(t,e){const a=new Date(t.toISOString().substring(0,10)+"T12:00Z"),n=Math.floor(a.getTime()/864e5+2440587.5)-2451545+8e-4-e.lon/360,r=(357.5291+.98560028*n)%360,s=(r+(1.9148*p(r)+.02*p(2*r)+3e-4*p(3*r))+180+102.9372)%360,i=2451545+n+.0053*p(r)-.0069*p(2*s),o=(c=p(s)*p(23.44),Math.asin(c)*(180/Math.PI));var c;const u=function(t){return Math.acos(t)*(180/Math.PI)}((p(-.83)-p(e.lat)*p(o))/(h(e.lat)*h(o)));function p(t){return Math.sin(t*(Math.PI/180))}function h(t){return Math.cos(t*(Math.PI/180))}function m(t){return new Date(864e5*(t-2440587.5))}return{sunrise:m(i-u/360),sunset:m(i+u/360)}}(n,a),s=function(t){const e=new Map;let a="clear-day",n=0;return t.forEach((t=>{t=t.replace("night","day");const r=(e.get(t)??0)+(t=>/thunderstorm|hail/.test(t)?12:/sleet|snow/.test(t)?5:1)(t);e.set(t,r),r>n&&(n=r,a=t)})),a}(e.filter((t=>{return(e=t.hours)>=7&&21>=e;var e})).map((t=>t.icon))),i=t(s);let{min:o,max:c,dayGraph:u}=function(e){let a=e.map((t=>t.temperature)).sort(((t,e)=>t-e));const[n,r]=[a[0],a[a.length-1]],s=r-n;return{min:{temperature:n},max:{temperature:r},dayGraph:e.map((({timestamp:e,temperature:a,precipitation:r,precipitation_probability:i,cloud_cover:o,wind_speed:c,wind_gust_speed:u,icon:p})=>({timestamp:new Date(e),temperature:a,temperatureFraction:0===s?0:Math.abs((a-n)/s),precipitationFraction:Math.min(Math.pow((1+i/100)*r*1.6,2),6)/6,sunninessFraction:1-o/100,wind:c,windGust:u,icon:p,iconClass:t(p)})))}}(e);return u=function(t){const e=new Date;function a(t,e,a,n){Math.abs(t[n]-e[n]),.1>e[n]&&t[n]>.2&&a[n]>.2&&(e[n]=Math.min(t[n],a[n])+Math.abs(t[n]-a[n])/2)}return t.map(((t,n,r)=>{if(0==n||n==r.length-1||t.timestamp>=e)return t;const s=r[n-1],i=r[n+1];return a(s,t,i,"precipitationFraction"),a(s,t,i,"sunninessFraction"),t}))}(u),{day:n,dayLight:r,daySummary:{icon:s,iconClass:i},min:o,max:c,dayGraph:u,data:e}}));return r}(await(await n(i.toString(),9)).json(),a)}(r,r.days);break;case"weatherWarningData":c=async function(t){return o.search=new URLSearchParams({...e(t)}).toString(),function(t){const e=Date.now();return(t?.alerts??[]).map((t=>{return{event:(n=t.event_de,n.toLowerCase().replace(/(^|\s)\p{L}/gu,(t=>t.toUpperCase()))??""),description:t.description_de??"",time:{start:new Date(t.onset),end:new Date(t.expires)},instruction:t.instruction_de??"",certainty:t.certainty,severity:t.severity,severityRank:(a=t.severety,{minor:1,moderate:2,severe:3,extreme:4}[a]??0),urgency:t.urgency,urgencyRank:(e=t.urgency,{future:1,immediate:2}[e]??0),responseType:t.response_type,category:t.category,type:t.event_code};var e,a,n})).filter((t=>t.time.end>e)).toSorted(function(...t){return(e,a)=>{for(const n of t){const t=n(e,a);if(0!==t)return t}return 0}}(((t,e)=>e.severityRank-t.severityRank),((t,e)=>t.severityRank-e.severityRank),((t,e)=>t.time.start.getTime()-e.time.start.getTime())))}(await(await n(o,19)).json())}(r)}postMessage({type:a,data:await c})}}();
