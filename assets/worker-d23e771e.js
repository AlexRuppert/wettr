!function(){"use strict";const t="x--cache-timestamp";async function e(e,n=1e6){let r=await caches.match(e);if(r&&r.headers.get(t)&&+r.headers.get(t)+6e4*n>Date.now())return console.log("cached "+e),r;r=await fetch(e);const o=new Headers(r.headers);o.set(t,Date.now().toString());const a=r.clone(),i=new Response(a.body,{status:a.status,statusText:a.statusText,headers:o});return(await caches.open("v1")).put(e,i),r}const n="https://api.brightsky.dev/",r=36e5;let o=new URL(n+"current_weather"),a=new URL(n+"weather");function i({lon:t,lat:e}){return{lon:t.toFixed(3),lat:e.toFixed(3)}}function s(t=new Date,e=!1){return t.toISOString().split("T")[0]+function(t=new Date,e=!1){const n=/[+-]\d{4}/.exec(t.toString())[0];return`T${e?"23:59":"00:00"}:00${n.slice(0,3)+":"+n.slice(3)}`}(t,e)}function l(t,e){return Object.fromEntries(t.map((t=>[t.replaceAll(/_([a-z])/g,((t,e)=>e.toUpperCase())).replaceAll(/_\d+/g,""),e[t]])))}function c(t){let e=t.map((t=>t.temperature)).sort(((t,e)=>t-e));const[n,r]=[e[0],e[e.length-1]],o=r-n;return{min:{temperature:n},max:{temperature:r},dayGraph:t.map((({timestamp:t,temperature:e,precipitation:r,precipitationProbability:a,cloudCover:i,windSpeed:s,windGustSpeed:l})=>({timestamp:new Date(t),temperaturePercent:0===o?0:Math.abs((e-n)/o),temperature:e,precipitationPercent:Math.min(Math.pow((1+a/100)*r*1.6,2),6)/6,sunninessPercent:1-i/100,wind:s,windGust:l})))}}function u(t,e){var n=t.length;if(n>=e)return t;var r=new Uint8Array(Math.max(n<<1,e));return r.set(t,0),r}function f(t,e,n,r,o,a){for(var i=w,s=v,l=0;n>l;){var c=t[s(r,o)&e];o+=15&c;var u=c>>>4;if(u>15){var f=0,h=0;16==u?(h=3+i(r,o,2),o+=2,f=a[l-1]):17==u?(h=3+i(r,o,3),o+=3):18==u&&(h=11+i(r,o,7),o+=7);for(var p=l+h;p>l;)a[l]=f,l++}else a[l]=u,l++}return o}function h(t,e,n,r){for(var o=0,a=0,i=r.length>>>1;n>a;){var s=t[a+e];r[a<<1]=0,r[1+(a<<1)]=s,s>o&&(o=s),a++}for(;i>a;)r[a<<1]=0,r[1+(a<<1)]=0,a++;return o}function p(t,e){for(var n,r,o,a,i=t.length,s=y.bl_count,l=0;e>=l;l++)s[l]=0;for(l=1;i>l;l+=2)s[t[l]]++;var c=y.next_code;for(n=0,s[0]=0,r=1;e>=r;r++)c[r]=n=n+s[r-1]<<1;for(o=0;i>o;o+=2)0!=(a=t[o+1])&&(t[o]=c[a],c[a]++)}function d(t,e,n){for(var r=t.length,o=y.rev15,a=0;r>a;a+=2)if(0!=t[a+1])for(var i=t[a+1],s=a>>1<<4|i,l=e-i,c=t[a]<<l,u=c+(1<<l);c!=u;)n[o[c]>>>15-e]=s,c++}function m(t,e){for(var n=y.rev15,r=15-e,o=0;t.length>o;o+=2)t[o]=n[t[o]<<e-t[o+1]]>>>r}function w(t,e,n){return(t[e>>>3]|t[1+(e>>>3)]<<8)>>>(7&e)&(1<<n)-1}function g(t,e,n){return(t[e>>>3]|t[1+(e>>>3)]<<8|t[2+(e>>>3)]<<16)>>>(7&e)&(1<<n)-1}function v(t,e){return(t[e>>>3]|t[1+(e>>>3)]<<8|t[2+(e>>>3)]<<16)>>>(7&e)}const y=(_=Uint16Array,b=Uint32Array,{next_code:new _(16),bl_count:new _(16),ordr:[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],of0:[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,999,999,999],exb:[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0],ldef:new _(32),df0:[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,65535,65535],dxb:[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0],ddef:new b(32),flmap:new _(512),fltree:[],fdmap:new _(32),fdtree:[],lmap:new _(32768),ltree:[],ttree:[],dmap:new _(32768),dtree:[],imap:new _(512),itree:[],rev15:new _(32768),lhst:new b(286),dhst:new b(30),ihst:new b(19),lits:new b(15e3),strt:new _(65536),prev:new _(32768)});var _,b;!function(){for(var t=0;32768>t;t++){var e=t;y.rev15[t]=((e=(4278255360&(e=(4042322160&(e=(3435973836&(e=(2863311530&e)>>>1|(1431655765&e)<<1))>>>2|(858993459&e)<<2))>>>4|(252645135&e)<<4))>>>8|(16711935&e)<<8)>>>16|e<<16)>>>17}function n(t,e,n){for(;0!=e--;)t.push(0,n)}for(t=0;32>t;t++)y.ldef[t]=y.of0[t]<<3|y.exb[t],y.ddef[t]=y.df0[t]<<4|y.dxb[t];n(y.fltree,144,8),n(y.fltree,112,9),n(y.fltree,24,7),n(y.fltree,8,8),p(y.fltree,9),d(y.fltree,9,y.flmap),m(y.fltree,9),n(y.fdtree,32,5),p(y.fdtree,5),d(y.fdtree,5,y.fdmap),m(y.fdtree,5),n(y.itree,19,0),n(y.ltree,286,0),n(y.dtree,30,0),n(y.ttree,320,0)}();const M={table:function(){for(var t=new Uint32Array(256),e=0;256>e;e++){for(var n=e,r=0;8>r;r++)1&n?n=3988292384^n>>>1:n>>>=1;t[e]=n}return t}(),update:function(t,e,n,r){for(var o=0;r>o;o++)t=M.table[255&(t^e[n+o])]^t>>>8;return t},crc:function(t,e,n){return 4294967295^M.update(4294967295,t,e,n)}};const S=Math.PI/180;function D(t){return Math.log(Math.tan(x(t)/2+Math.PI/4))}function x(t){return t*S}function P(t,{lon:e,lat:n}){return{x:x(e-t.lb.lon),y:D(n)-D(t.lb.lat)}}function T(t){const e=[];return t.forEach((t=>{const n=t.lon_bucket,r=t.lat_bucket,o=(a=Uint8Array.from(atob(t.data).split("").map((t=>t.charCodeAt(0)))),function(t,e){return function(t,e){var n=Uint8Array;if(3==t[0]&&0==t[1])return e||new n(0);var r=g,o=w,a=f,i=v,s=null==e;s&&(e=new n(t.length>>>2<<3));for(var l,c,m=0,_=0,b=0,M=0,S=0,D=0,x=0,P=0,T=0;0==m;)if(m=r(t,T,1),_=r(t,T+1,2),T+=3,0!=_){if(s&&(e=u(e,P+(1<<17))),1==_&&(l=y.flmap,c=y.fdmap,D=511,x=31),2==_){b=o(t,T,5)+257,M=o(t,T+5,5)+1,S=o(t,T+10,4)+4,T+=14;for(var C=0;38>C;C+=2)y.itree[C]=0,y.itree[C+1]=0;var A=1;for(C=0;S>C;C++){var I=o(t,T+3*C,3);y.itree[1+(y.ordr[C]<<1)]=I,I>A&&(A=I)}T+=3*S,p(y.itree,A),d(y.itree,A,y.imap),l=y.lmap,c=y.dmap,T=a(y.imap,(1<<A)-1,b+M,t,T,y.ttree);var U=h(y.ttree,0,b,y.ltree);D=(1<<U)-1;var O=h(y.ttree,b,M,y.dtree);x=(1<<O)-1,p(y.ltree,U),d(y.ltree,U,l),p(y.dtree,O),d(y.dtree,O,c)}for(;;){var N=l[i(t,T)&D];T+=15&N;var j=N>>>4;if(j>>>8==0)e[P++]=j;else{if(256==j)break;var z=P+j-254;if(j>264){var $=y.ldef[j-257];z=P+($>>>3)+o(t,T,7&$),T+=7&$}var k=c[i(t,T)&x],L=y.ddef[k>>>4],E=(L>>>4)+r(t,T+=15&k,15&L);for(T+=15&L,s&&(e=u(e,P+(1<<17)));z>P;)e[P]=e[P++-E],e[P]=e[P++-E],e[P]=e[P++-E],e[P]=e[P++-E];P=z}}}else{0!=(7&T)&&(T+=8-(7&T));var F=4+(T>>>3),R=t[F-4]|t[F-3]<<8;s&&(e=u(e,P+R)),e.set(new n(t.buffer,t.byteOffset+F,R),P),T=F+R<<3,P+=R}return e.length==P?e:e.slice(0,P)}(t,e)}(new Uint8Array(a.buffer,a.byteOffset+2,a.length-6),undefined));var a;let i=0;for(let s=0;o.length>s;s++){const a=o[s];128&a?i+=-129&a:(e.push({time:t.time,lon:n+i%100/100,lat:r+(i/100|0)/100,value:a/100}),i++)}})),e}function C(t,e){const n=new Date(t);return new Date(n.setMinutes(n.getMinutes()+e))}function A(t,e,n,r,o,a){const i=(a-e)*(n-t)-(r-e)*(o-t);return i>0||i>=0}function I(t,e){this._cells=[],this._cellSize=e,this._reverseCellSize=1/e;for(let n=0;t.length>n;n++){const e=t[n],r=this.coordToCellNum(e[0]),o=this.coordToCellNum(e[1]);if(this._cells[r])this._cells[r][o]?this._cells[r][o].push(e):this._cells[r][o]=[e];else{const t=[];t[o]=[e],this._cells[r]=t}}}function U(t,e,n){return(e[0]-t[0])*(n[1]-t[1])-(e[1]-t[1])*(n[0]-t[0])}I.prototype={cellPoints:function(t,e){return void 0!==this._cells[t]&&void 0!==this._cells[t][e]?this._cells[t][e]:[]},rangePoints:function(t){const e=this.coordToCellNum(t[0]),n=this.coordToCellNum(t[1]),r=this.coordToCellNum(t[2]),o=this.coordToCellNum(t[3]),a=[];for(let i=e;r>=i;i++)for(let t=n;o>=t;t++)for(let e=0;e<this.cellPoints(i,t).length;e++)a.push(this.cellPoints(i,t)[e]);return a},removePoint:function(t){const e=this.coordToCellNum(t[0]),n=this.coordToCellNum(t[1]),r=this._cells[e][n];let o;for(let a=0;r.length>a;a++)if(r[a][0]===t[0]&&r[a][1]===t[1]){o=a;break}return r.splice(o,1),r},trunc:Math.trunc||function(t){return t-t%1},coordToCellNum:function(t){return this.trunc(t*this._reverseCellSize)},extendBbox:function(t,e){return[t[0]-e*this._cellSize,t[1]-e*this._cellSize,t[2]+e*this._cellSize,t[3]+e*this._cellSize]}};const O=function(t,e){const n=t[0][0],r=t[0][1],o=t[1][0],a=t[1][1],i=e[0][0],s=e[0][1],l=e[1][0],c=e[1][1];return A(n,r,i,s,l,c)!==A(o,a,i,s,l,c)&&A(n,r,o,a,i,s)!==A(n,r,o,a,l,c)},N=function(t,e){return void 0===e?t.slice():t.map((function(t){return new Function("pt","return [pt"+e[0]+",pt"+e[1]+"];")(t)}))},j=function(t,e){return void 0===e?t.slice():t.map((function(t){return new Function("pt","const o = {}; o"+e[0]+"= pt[0]; o"+e[1]+"= pt[1]; return o;")(t)}))},z=function(t){const e=function(t){const e=[];for(let n=0;t.length>n;n++){for(;e.length>=2&&0>=U(e[e.length-2],e[e.length-1],t[n]);)e.pop();e.push(t[n])}return e.pop(),e}(t),n=function(t){const e=t.reverse(),n=[];for(let r=0;e.length>r;r++){for(;n.length>=2&&0>=U(n[n.length-2],n[n.length-1],e[r]);)n.pop();n.push(e[r])}return n.pop(),n}(t).concat(e);return n.push(t[0]),n};function $(t,e){return Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)}function k(t,e,n){const r=[e[0]-t[0],e[1]-t[1]],o=[n[0]-t[0],n[1]-t[1]],a=$(t,e),i=$(t,n);return(r[0]*o[0]+r[1]*o[1])/Math.sqrt(a*i)}function L(t,e){for(let n=0;e.length-1>n;n++){const r=[e[n],e[n+1]];if(!(t[0][0]===r[0][0]&&t[0][1]===r[0][1]||t[0][0]===r[1][0]&&t[0][1]===r[1][1])&&O(t,r))return!0}return!1}function E(t){return[Math.min(t[0][0],t[1][0]),Math.min(t[0][1],t[1][1]),Math.max(t[0][0],t[1][0]),Math.max(t[0][1],t[1][1])]}function F(t,e,n){let r,o,a=null,i=B,s=B;for(let l=0;e.length>l;l++)r=k(t[0],t[1],e[l]),o=k(t[1],t[0],e[l]),r>i&&o>s&&!L([t[0],e[l]],n)&&!L([t[1],e[l]],n)&&(i=r,s=o,a=e[l]);return a}function R(t,e,n,r,o){let a=!1;for(let i=0;t.length-1>i;i++){const s=[t[i],t[i+1]],l=s[0][0]+","+s[0][1]+","+s[1][0]+","+s[1][1];if($(s[0],s[1])<e||o.has(l))continue;let c,u,f,h=0,p=E(s);do{p=r.extendBbox(p,h),c=p[2]-p[0],u=p[3]-p[1],f=F(s,r.rangePoints(p),t),h++}while(null===f&&(n[0]>c||n[1]>u));n[0]>c||n[1]>u||o.add(l),null!==f&&(t.splice(i+1,0,f),r.removePoint(f),a=!0)}return a?R(t,e,n,r,o):t}const B=Math.cos(90/(180/Math.PI));var G=function(t,e,n){let r=e||20;const o=function(t){const e=[t[0]];let n=t[0];for(let r=1;t.length>r;r++){const o=t[r];n[0]===o[0]&&n[1]===o[1]||e.push(o),n=o}return e}(function(t){return t.sort((function(t,e){return t[0]-e[0]||t[1]-e[1]}))}(N(t,n)));if(4>o.length){const t=o.concat([o[0]]);return n?j(t,n):t}const a=function(t){let e=1/0,n=1/0,r=-1/0,o=-1/0;for(let a=t.length-1;a>=0;a--)e>t[a][0]&&(e=t[a][0]),n>t[a][1]&&(n=t[a][1]),t[a][0]>r&&(r=t[a][0]),t[a][1]>o&&(o=t[a][1]);return[r-e,o-n]}(o),i=[.6*a[0],.6*a[1]],s=z(o),l=o.filter((function(t){return 0>s.indexOf(t)})),c=Math.ceil(1/(o.length/(a[0]*a[1]))),u=R(s,Math.pow(r,2),i,function(t,e){return new I(t,e)}(l,c),new Set);return n?j(u,n):u},W={};function Z(t,e){return t*t+e*e}function H(t,e,n){var r=e[0],o=e[1],a=n[0]-r,i=n[1]-o;if(0!==a||0!==i){var s=((t[0]-r)*a+(t[1]-o)*i)/Z(a,i);s>1?(r=n[0],o=n[1]):s>0&&(r+=a*s,o+=i*s)}return Z(t[0]-r,t[1]-o)}function q(t,e,n,r,o){for(var a,i=r,s=e+1;n>s;s++){var l=H(t[s],t[e],t[n]);l>i&&(a=s,i=l)}i>r&&(a-e>1&&q(t,e,a,r,o),o.push(t[a]),n-a>1&&q(t,a,n,r,o))}function J(t,e){var n=t.length-1,r=[t[0]];return q(t,0,n,e,r),r.push(t[n]),r}W.__esModule=!0,W.SimplifyAP=function(t,e,n){if(void 0===e&&(e=1),void 0===n&&(n=!1),2>=t.length)return t;var r=e*e;return J(t=n?t:function(t,e){for(var n,r,o,a=t[0],i=[a],s=1,l=t.length;l>s;s++)Z((r=n=t[s])[0]-(o=a)[0],r[1]-o[1])>e&&(i.push(n),a=n);return a!==n&&i.push(n),i}(t,r),r)};var K=W.SimplifyAP;function Q(t,e,n){return t.level>2&&e>n}onmessage=async function({data:{type:t,data:n}}){let u;switch(t){case"currentWeatherData":u=async function(t,n){return o.search=new URLSearchParams({...i({lon:n,lat:t}),tz:Intl.DateTimeFormat().resolvedOptions().timeZone}).toString(),function(t){const e=l(["timestamp","cloud_cover","condition","dew_point","precipitation_60","precipitation_probability","pressure_msl","relative_humidity","visibility","wind_direction_10","wind_speed_10","wind_gust_direction_10","wind_gust_speed_10","sunshine_30","temperature","icon"],t.weather);return{...e,temperature:Math.round(e.temperature)}}(await(await e(o.toString(),9)).json())}(n.lat,n.lon);break;case"weatherData":u=async function(t,n,o=3){const u=new Date,f=new Date(u.getTime()+864e5*o-10);a.search=new URLSearchParams({...i({lon:n,lat:t}),days:o.toString(),date:s(u),last_date:s(f,!0)}).toString();const h=function(t,e,n){const o=new Map;console.log(t),t.weather.forEach((t=>{const e=l(Object.keys(t),t),n={...e,temperature:Math.round(e.temperature),hours:new Date(e.timestamp).getHours()},[a,i]=n.timestamp.split("T"),s=+n.timestamp.split("+")[1].replace(":","")/100;let c=new Date(new Date(a).getTime()-s*r);if(i.startsWith("00")){const t=new Date(c.getTime()-864e5);o.get(t.toISOString())?.push({...n})}o.get(c.toISOString())?.push(n)??o.set(c.toISOString(),[n])}));const a=Array.from(o.entries()).map((([t,r])=>{const o=new Date(t),a=function(t,e,n){const r=new Date(t.toISOString().substr(0,10)+"T12:00Z");function o(t){return Math.sin(t*(Math.PI/180))}function a(t){return Math.cos(t*(Math.PI/180))}function i(t){return new Date(864e5*(t-2440587.5))}const s=Math.floor(r.getTime()/864e5+2440587.5)-2451545+8e-4-n/360,l=(357.5291+.98560028*s)%360,c=(l+(1.9148*o(l)+.02*o(2*l)+3e-4*o(3*l))+180+102.9372)%360,u=2451545+s+.0053*o(l)-.0069*o(2*c),f=(h=o(c)*o(23.44),Math.asin(h)*(180/Math.PI));var h;const p=function(t){return Math.acos(t)*(180/Math.PI)}((o(-.83)-o(e)*o(f))/(a(e)*a(f)));return{sunrise:i(u-p/360),sunset:i(u+p/360)}}(o,e,n);let i={day:[],morning:[],noon:[],evening:[]};return r.forEach((t=>{[["day",0,24],["morning",4,9],["noon",10,22],["evening",18,22]].forEach((([e,n,r])=>{return(o=t.hours)>=+n&&+r>=o&&i[e].push(t);var o}))})),{day:o,dayLight:a,dayParts:[i.morning,i.noon,i.evening].map((t=>({icon:function(t){const e=new Map;let n="clear-day",r=0;return t.forEach((t=>{const o=t.icon.replace("night","day"),a=(e.get(o)??0)+(t=>/thunderstorm|hail/.test(t)?12:1)(o);e.set(o,a),a>r&&(r=a,n=o)})),n}(t)}))),...c(i.day),data:r}}));return a}(await(await e(a.toString(),9)).json(),t,n);return h}(n.lat,n.lon,n.days);break;case"cloudData":case"currentCloudData":u=async function(t,n=!1){let r=(await async function(t,n=!1){return T(await(await e(`https://wettr-service.vercel.app/api/clouds?bounds=${t.lb.lon},${t.rt.lon},${t.lb.lat},${t.rt.lat}${n?"&onlyNow=true":""}`,9)).json())}(t,n)).filter((e=>function({lon:t,lat:e},n){const r=.02;return!(n.lb.lon>t+r||t-r>n.rt.lon||n.lb.lat>e+r||e-r>n.rt.lat)}(e,t))).map((e=>({...e,projected:P(t,e)})));return r.sort(((t,e)=>t.value-e.value)),r=Array.from(new Map(r.map((t=>[`${t.time} ${1e4*t.projected.x|0} ${1e4*t.projected.y|0}`,t]))).values()),{times:function(){const t=new Date(Date.now()-3e5).toISOString(),e=15*(+t.match(/:(\d\d):/)[1]/15|0),n=C(new Date(t.substring(0,13)+":00:00Z"),e);return[...Array(9)].map(((t,e)=>C(n,15*e)))}(),clouds:r,viewBounds:t}}(n.bounds,n.onlyNow);break;case"weatherWarningData":u=async function(){return function(t){const e=Date.now();return function(t){const e=t.slice();return e.sort(((t,e)=>{const n=t.level-e.level;return 0===n?t.time.start.getTime()-e.time.start.getTime():n})),e}(t.warnings.map((t=>{return{event:(n=t.event,n.toLowerCase().replace(/(^|\s)\p{L}/gu,(t=>t.toUpperCase()))),description:t.description,time:{start:new Date(t.start),end:new Date(t.end)},instruction:t.instruction,level:t.level,type:t.type,regions:Q(t,t.end,e)?t.regions.map((t=>function(t){const e={lon:100,lat:100},n={lon:0,lat:0},r=[];for(let a=0;t.length/2>a;a+=3)r.push([t[2*a+1],t[2*a]]);const o=K(G(r,.1),.02,!1);for(let a=0;o.length>a;a++){const[t,r]=o[a];e.lon>t?e.lon=t:t>n.lon&&(n.lon=t),e.lat>r?e.lat=r:r>n.lat&&(n.lat=r)}return{polygon:o,bounds:{lb:e,rt:n}}}(t.polygon))):[],urls:t.urls};var n})).filter((t=>Q(t,t.time.end,e))))}(await(await e("https://s3.eu-central-1.amazonaws.com/app-prod-static.warnwetter.de/v16/gemeinde_warnings_v2.json",19)).json())}()}postMessage({type:t,data:await u})}}();
